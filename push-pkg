#!/bin/bash
# One-click package push to Linux Hardened repos
# Usage: push-pkg <package.rpm|package.deb>
# Works from any machine - auto-clones repos if needed

set -e

PKG="$1"
RPM_REPO="$HOME/rpm-repos"
DEB_REPO="$HOME/deb-repos"
GH_USER="rushikeshsakharleofficial"

if [ -z "$PKG" ] || [ ! -f "$PKG" ]; then
    echo "Usage: push-pkg <package.rpm|package.deb>"
    exit 1
fi

PKG_NAME=$(basename "$PKG")
EXT="${PKG_NAME##*.}"

# Check dependencies based on package type
check_deps() {
    if [ "$EXT" = "rpm" ]; then
        command -v createrepo_c >/dev/null || { echo "‚ùå Install: sudo apt install createrepo-c"; exit 1; }
    elif [ "$EXT" = "deb" ]; then
        command -v dpkg-scanpackages >/dev/null || { echo "‚ùå Install: sudo apt install dpkg-dev"; exit 1; }
    fi
    command -v git >/dev/null || { echo "‚ùå Install: sudo apt install git"; exit 1; }
}

# Clone repos if not present
ensure_repos() {
    if [ "$EXT" = "rpm" ] && [ ! -d "$RPM_REPO/.git" ]; then
        echo "üì• Cloning rpm-repos..."
        git clone "https://github.com/$GH_USER/rpm-repos.git" "$RPM_REPO"
    fi
    if [ "$EXT" = "deb" ] && [ ! -d "$DEB_REPO/.git" ]; then
        echo "üì• Cloning deb-repos..."
        git clone "https://github.com/$GH_USER/deb-repos.git" "$DEB_REPO"
    fi
}

generate_index() {
    local dir="$1" url_path="$2"
    cat > "${dir}index.html" << EOF
<!DOCTYPE html>
<html><head><title>Index of $url_path</title>
<style>body{font-family:monospace;background:#fff;color:#000;margin:20px}
h1{font-size:1.2em}hr{border:none;border-top:1px solid #ccc}
table{border-collapse:collapse}th,td{text-align:left;padding:4px 15px 4px 0}
a{color:#0000ee}a:hover{text-decoration:underline}.size{color:#666}</style></head>
<body><h1>Index of $url_path</h1><hr><table>
<tr><th>Name</th><th>Size</th></tr>
<tr><td><a href="../">../</a></td><td class="size">-</td></tr>
EOF
    for item in "$dir"*/; do
        [ -d "$item" ] && echo "<tr><td><a href=\"$(basename "$item")/\">$(basename "$item")/</a></td><td class=\"size\">-</td></tr>" >> "${dir}index.html"
    done
    for item in "$dir"*; do
        [ -f "$item" ] && [ "$(basename "$item")" != "index.html" ] && \
        echo "<tr><td><a href=\"$(basename "$item")\">$(basename "$item")</a></td><td class=\"size\">$(du -h "$item"|cut -f1)</td></tr>" >> "${dir}index.html"
    done
    echo '</table><hr></body></html>' >> "${dir}index.html"
}

regenerate_all_indexes() {
    local base="$1"
    find "$base" -type d | sort | while read d; do
        local url_path="/${d#./}"
        generate_index "$d/" "$url_path"
    done
}

get_rpm_arch() {
    local pkg="$1"
    local filename=$(basename "$pkg")

    # Try rpm command first
    if command -v rpm >/dev/null 2>&1; then
        local arch=$(rpm -qp --qf '%{ARCH}' "$pkg" 2>/dev/null)
        if [ -n "$arch" ] && [ "$arch" != "(none)" ]; then
            echo "$arch"
            return
        fi
    fi

    # Fallback: extract from filename
    if [[ "$filename" =~ \.x86_64\.rpm$ ]]; then
        echo "x86_64"
    elif [[ "$filename" =~ \.aarch64\.rpm$ ]]; then
        echo "aarch64"
    elif [[ "$filename" =~ \.arm64\.rpm$ ]]; then
        echo "aarch64"
    elif [[ "$filename" =~ \.noarch\.rpm$ ]]; then
        echo "noarch"
    elif [[ "$filename" =~ \.i686\.rpm$ ]]; then
        echo "i686"
    else
        echo "x86_64"
    fi
}

get_rpm_name() {
    local pkg="$1"
    local filename=$(basename "$pkg")

    # Try rpm command first
    if command -v rpm >/dev/null 2>&1; then
        local name=$(rpm -qp --qf '%{NAME}' "$pkg" 2>/dev/null)
        if [ -n "$name" ] && [ "$name" != "(none)" ]; then
            echo "$name"
            return
        fi
    fi

    # Fallback: extract from filename (NAME-version-release.arch.rpm)
    echo "$filename" | sed -E 's/-[0-9]+\.[0-9]+.*$//'
}

get_deb_field() {
    local pkg="$1" field="$2" fallback="$3"
    local value=""

    if command -v dpkg-deb >/dev/null 2>&1; then
        value=$(dpkg-deb -f "$pkg" "$field" 2>/dev/null)
    fi

    if [ -z "$value" ]; then
        echo "$fallback"
    else
        echo "$value"
    fi
}

push_rpm() {
    local pkg="$1"
    local name=$(get_rpm_name "$pkg")
    local arch=$(get_rpm_arch "$pkg")
    local letter="${name:0:1}"
    local dest="$RPM_REPO/packages/$arch/$letter"

    echo "üì¶ Package: $name ($arch)"

    mkdir -p "$dest"
    cp "$pkg" "$dest/"

    echo "üîÑ Updating repo metadata..."
    cd "$RPM_REPO"

    # Pull latest changes first
    git pull --rebase 2>/dev/null || true

    createrepo_c --update "packages/$arch"

    echo "üîÑ Regenerating indexes..."
    regenerate_all_indexes "packages"

    echo "üì§ Pushing to GitHub..."
    git add packages/
    git commit -m "Add $PKG_NAME" || echo "No changes to commit"
    git push

    echo "‚úÖ Done! Package available at:"
    echo "   https://rpm.linuxhardened.com/packages/$arch/$letter/$PKG_NAME"
}

push_deb() {
    local pkg="$1"
    local filename=$(basename "$pkg")
    local name=$(get_deb_field "$pkg" "Package" "$(echo "$filename" | sed 's/_.*$//')")
    local arch=$(get_deb_field "$pkg" "Architecture" "amd64")
    local letter="${name:0:1}"
    local dest="$DEB_REPO/pool/main/$letter"

    echo "üì¶ Package: $name ($arch)"

    mkdir -p "$dest"
    cp "$pkg" "$dest/"

    echo "üîÑ Updating repo metadata..."
    cd "$DEB_REPO"

    # Pull latest changes first
    git pull --rebase 2>/dev/null || true

    dpkg-scanpackages --arch amd64 pool/ > dists/stable/main/binary-amd64/Packages 2>/dev/null
    gzip -k -f dists/stable/main/binary-amd64/Packages
    dpkg-scanpackages --arch arm64 pool/ > dists/stable/main/binary-arm64/Packages 2>/dev/null
    gzip -k -f dists/stable/main/binary-arm64/Packages

    cd dists/stable
    cat > Release << EOF
Origin: Linux Hardened
Label: Linux Hardened
Suite: stable
Codename: stable
Architectures: amd64 arm64
Components: main
Description: Linux Hardened DEB Repository
EOF
    echo "SHA256:" >> Release
    for f in main/binary-*/Packages*; do
        echo " $(sha256sum $f | cut -d' ' -f1) $(wc -c < $f) $f" >> Release
    done
    cd "$DEB_REPO"

    echo "üîÑ Regenerating indexes..."
    regenerate_all_indexes "pool"
    regenerate_all_indexes "dists"

    echo "üì§ Pushing to GitHub..."
    git add .
    git commit -m "Add $PKG_NAME" || echo "No changes to commit"
    git push

    echo "‚úÖ Done! Package available at:"
    echo "   https://deb.linuxhardened.com/pool/main/$letter/$PKG_NAME"
}

# Main
check_deps
ensure_repos

case "$EXT" in
    rpm) push_rpm "$PKG" ;;
    deb) push_deb "$PKG" ;;
    *) echo "‚ùå Unknown type: $EXT (use .rpm or .deb)"; exit 1 ;;
esac
